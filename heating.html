<html>
<head profile="http://www.w3.org/2005/10/profile">
<link rel="icon"
      type="image/png"
      href="../short_logo_trans.png">
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>SmartAtHome.co.uk - My Hive Heating Control</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
<script src="functions.js"></script>
<script>
var pagelink = location.origin+location.pathname;
var hub_type = 'heating';
user_info = checklogin();
var headers = user_info['headers'];
if (headers == null) {
	window.location.replace('index.html');
};

/*
var location_id = getCookie('location_id');
if (location_id == "") {
	var latitude = user_info['user']['latitude'];
	var longitude = user_info['user']['longitude'];
	var location_id = get_location_id(latitude, longitude);
	setCookie('location_id', location_id, 365)
}
*/

device_info = get_device_info(headers, hub_type, null);
var id_ = device_info['id'];
var currentTemp = device_info['props']['temperature'];
var currentTarget = device_info['state']['target'];
var currentMode = device_info['state']['mode'];
var currentBoost = device_info['state']['boost'];
var readyBy = device_info['state']['optimumStart'];

var now = new Date();
currentAndNextEvent = getCurrentAndNextEvent(device_info, now.getDay(), now.getHours(), now.getMinutes())
if (!currentAndNextEvent['currentEvent']) {
	currentAndNextEvent2 = getCurrentAndNextEvent(device_info, now.getDay()-1, 24, 0)
	currentAndNextEvent['currentEvent'] = currentAndNextEvent2['currentEvent']
}
if (!currentAndNextEvent['nextEvent']) {
	currentAndNextEvent2 = getCurrentAndNextEvent(device_info, now.getDay()+1, 0, 0)
	currentAndNextEvent['nextEvent'] = currentAndNextEvent2['nextEvent']
}

const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);

var startdate = new Date();
if (urlParams.has('start')) {
	var start = urlParams.get('start');
	startdate = parseDateParam(start)
} else {
	startdate.setDate(startdate.getDate() - 1);
}

var enddate = new Date();
if (urlParams.has('end')) {
	var end = urlParams.get('end');
	enddate = parseDateParam(end)
}

if (startdate.getFullYear() === enddate.getFullYear() &&
	startdate.getMonth() === startdate.getMonth() &&
	startdate.getDate() === enddate.getDate()) {
		var tooltipFormat="HH:mm:ss";
} else {
		var tooltipFormat="DD-MM-YY HH:mm:ss";
}

temps = get_temps(headers, id_, startdate, enddate)
var hiveDataPoints = [];
for (i in temps) {
	hiveDataPoints.push({x: parseInt(temps[i]['date']), y: temps[i]['temperature']});
}

schedule_temps = get_schedule_for_plotting(startdate, enddate, device_info)
var schedDataPoints = [];
for (i in schedule_temps) {
	schedDataPoints.push({x: schedule_temps[i]['date'], y: schedule_temps[i]['temperature']});
}

/*
weather = get_weather(startdate, enddate, location_id);
var weatherDataPoints = [];
for (i in weather) {
	weatherDataPoints.push({x: parseInt(i), y: weather[i]});
}
*/

var dataSets = [];
dataSets.push({borderColor:'#0000ff', label:'Hive', fill:false, data:hiveDataPoints});
dataSets.push({pointHitRadius:20, borderColor:'#ff0000', label:'Schedule', fill:false, steppedLine:true, data:schedDataPoints});
//dataSets.push({pointHitRadius:20, borderColor:'#00ff00', label:'Weather', fill:false, data:weatherDataPoints});

var config = get_config(tooltipFormat, false);

window.onload = function() {
	var ctx = document.getElementById('myChart').getContext('2d');
	var myChart = new Chart(ctx, config);
	document.getElementById('currentTempId').innerHTML = currentTemp+'&deg;C';
	document.getElementById('currentTargetId').innerHTML = currentTarget+'&deg;C';
	document.getElementById('tempToSet').value = currentTarget;
	document.getElementById('boostTempToSet').value = currentTarget+1;
	document.getElementById('advanceInfo').innerHTML = ' to '+currentAndNextEvent['nextEvent']['value']['target']+'&deg;C';
	if (currentMode == 'BOOST') {
		document.getElementById('boosting').innerHTML = 'Now Boosting';
		document.getElementById('boostTime').value = currentBoost;
		document.getElementById('boostOrStop').innerHTML = 'Stop';
	} else if (currentAndNextEvent['currentEvent']['value']['target'] != currentTarget) {
		document.getElementById('advanceOrStop').innerHTML = 'Back to Schedule';
		document.getElementById('advanceInfo').innerHTML = '';
	}
	if (readyBy) {
		document.getElementById('readyById').innerHTML = 'On';
		document.getElementById('enableReadyBy').innerHTML = 'Disable';
	} else {
		document.getElementById('readyById').innerHTML = 'Off';
	}
};

function setTemp() {
	temp = document.getElementById("tempToSet").value;
	var data = {'target': temp};
	sendData(headers, hub_type, id_, data);
	location.reload();
}

function enableReadyBy() {
	if (document.getElementById('enableReadyBy').innerHTML == 'Enable') {
		document.getElementById('enableReadyBy').innerHTML = 'Enabling...'
		var data = {'optimumStart': true}
	} else {
		document.getElementById('enableReadyBy').innerHTML = 'Disabling...'
		var data = {'optimumStart': false}
	}
	sendData(headers, hub_type, id_, data);
	location.reload();
}

function boostOrStop() {
	if (document.getElementById('boostOrStop').innerHTML == 'Stop') {
		stopBoost();
	} else {
		boostTemp();
	}
}

function advanceOrStop() {
	if (document.getElementById('advanceOrStop').innerHTML == 'Back to Schedule') {
		stopBoost();
	} else {
		advanceTemp();
	}
}

function advanceTemp() {
	document.getElementById('advanceOrStop').innerHTML = 'Advancing...'
	temp = currentAndNextEvent['nextEvent']['value']['target']
	var data={'target': temp};
	sendData(headers, hub_type, id_, data);
	location.reload();
}

function boostTemp() {
	document.getElementById('boostOrStop').innerHTML = 'Boosting...'
	temp = document.getElementById("boostTempToSet").value;
	time = document.getElementById("boostTime").value;
	var data={'mode': 'BOOST', 'boost': time, 'target': temp};
	sendData(headers, hub_type, id_, data);
	location.reload();
}

function stopBoost() {
	document.getElementById('boostOrStop').innerHTML = 'Stopping...';
	schedule();
}

</script>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>
<body>
<center><img src="../long_logo.png"></center><br /><br />
<table border=0 align=center width=90%><tr align=center>
<th width=20%>Current Temperature</th><th width=20%>Current Setpoint</th><th width=20%>New setpoint</th>
<th width=20% id='boosting'>Boost</th><th width=20%>Ready By</th></tr>
<tr align=center><td id='currentTempId' style='padding-top: 0px'>&deg;C</td>
<td id='currentTargetId' style='padding-top: 0px'>&deg;C</td>
<td style='padding-top: 16px'><form onsubmit='setTemp(); return false'><input id='tempToSet' type=text size=3 style='text-align:center;'></input>&deg;C<input type='submit' hidden /></form></td>
<td style='padding-top: 16px'><form onsubmit='boostTemp(); return false'><input id='boostTempToSet' type=text size=3 style='text-align:center;'></input>&deg;C for <input id='boostTime' type=text size=1 value=5 style='text-align:center;'>mins</input><input type='submit' hidden /></form></td>
<td id='readyById' style='padding-top: 0px'></td></tr>
<tr align=center><td><button type="button" id="off" onclick='off();'>Off</button> <button type="button" id="schedule" onclick='schedule();'>Schedule</button> <button type="button" id="on" onclick='on();'>On</button></td>
<td><button type="button" id="advanceOrStop" onclick='advanceOrStop();'>Advance</button><span id='advanceInfo'></span></td>
<td></td><td><button type="button" id="boostOrStop" onclick='boostOrStop();'>Boost</button></td>
<td><button type="button" id="enableReadyBy" onclick='enableReadyBy();'>Enable</button></td>
</tr></table>

<canvas id="myChart" width="800" height="400"></canvas>

<br /><br /><center><form>
<input type='button' onClick='window.location.href=pagelink+"?start=-1hour&end=now";' value='Last 1 hour' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.href=pagelink+"?start=-12hours&end=now";' value='Last 12 hours' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.reload(true);' value='Refresh' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.href=pagelink+"?start=-24hours&end=now";' value='Last 24 hours' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.href=pagelink+"?start=-7days&end=now";' value='Last 7 days' style='font-size:20px;height:100px;width:200px'>

</form></center><br />
<a href='schedule.html'>Schedule Control</a><br />
<a href='hotwater.html'>Hot Water Control</a><br />
</body>
</html>
